<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Piano</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
      /* Custom CSS for piano keys and layout */
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        overflow: hidden; /* Prevent scrolling */
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh; /* Full viewport height */
        background-color: #1a202c; /* Dark background */
      }
      .piano-container {
        position: relative;
        display: flex;
        width: 95vw; /* Use most of the viewport width for a wider piano */
        max-width: 1400px; /* Limit max width for very large screens */
        height: 600px; /* Increased height for a larger piano */
        background-color: #333;
        border-radius: 1rem;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        padding: 1.5rem;
        box-sizing: border-box; /* Include padding in width/height */
      }
      .white-keys {
        display: flex;
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 1;
      }
      .black-keys {
        position: absolute;
        top: 1.5rem; /* Match piano-container padding-top */
        left: 1.5rem; /* Match piano-container padding-left */
        width: calc(100% - 3rem); /* Adjust width to fit within padding */
        height: 60%; /* Black keys are shorter */
        display: flex;
        z-index: 2;
        pointer-events: none; /* Allow clicks to pass through to white keys where there's no black key */
      }
      .key {
        flex-grow: 1;
        border-radius: 0.5rem;
        margin: 0 2px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 10px;
        font-size: 0.8rem;
        user-select: none; /* Prevent text selection */
        transition: background-color 0.1s ease-out, transform 0.05s ease-out;
        box-sizing: border-box;
        white-space: nowrap; /* Prevent note labels from wrapping */
        overflow: hidden; /* Hide overflow if notes are too long */
        text-overflow: ellipsis; /* Add ellipsis if hidden */
      }
      .white-key {
        background-color: #f8f8f8;
        border: 1px solid #ccc;
        box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.2);
        position: relative;
        height: 100%;
      }
      .white-key.active {
        background-color: #e0e0e0;
        transform: translateY(2px);
        box-shadow: inset 0 -2px 5px rgba(0, 0, 0, 0.2);
      }
      .black-key {
        background-color: #222;
        border: 1px solid #000;
        box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.5);
        position: absolute; /* Positioned relative to .black-keys container */
        width: calc(
          100% / 19 * 0.6
        ); /* Black key width is 60% of a white key's width */
        height: 100%;
        margin: 0; /* Override white key margin */
        z-index: 3; /* Ensure black keys are on top */
        pointer-events: auto; /* Make black keys clickable */
        color: white; /* Black key note color */
      }
      .black-key.active {
        background-color: #000;
        transform: translateY(2px);
        box-shadow: inset 0 -2px 5px rgba(0, 0, 0, 0.5);
      }

      /* Black key positioning for 19 white keys */
      /* Formula: left = (white_key_index_to_the_left + 0.2) * (100% / 19) */

      /* C#3 (between C3 and D3, white key index 0) */
      .black-key[data-note="C#3"] {
        left: calc(0.2 * (100% / 19));
      }
      /* D#3 (between D3 and E3, white key index 1) */
      .black-key[data-note="D#3"] {
        left: calc(1.2 * (100% / 19));
      }
      /* F#3 (between F3 and G3, white key index 3) */
      .black-key[data-note="F#3"] {
        left: calc(3.2 * (100% / 19));
      }
      /* G#3 (between G3 and A3, white key index 4) */
      .black-key[data-note="G#3"] {
        left: calc(4.2 * (100% / 19));
      }
      /* A#3 (between A3 and B3, white key index 5) */
      .black-key[data-note="A#3"] {
        left: calc(5.2 * (100% / 19));
      }

      /* C#4 (between C4 and D4, white key index 7) */
      .black-key[data-note="C#4"] {
        left: calc(7.2 * (100% / 19));
      }
      /* D#4 (between D4 and E4, white key index 8) */
      .black-key[data-note="D#4"] {
        left: calc(8.2 * (100% / 19));
      }
      /* F#4 (between F4 and G4, white key index 10) */
      .black-key[data-note="F#4"] {
        left: calc(10.2 * (100% / 19));
      }
      /* G#4 (between G4 and A4, white key index 11) */
      .black-key[data-note="G#4"] {
        left: calc(11.2 * (100% / 19));
      }
      /* A#4 (between A4 and B4, white key index 12) */
      .black-key[data-note="A#4"] {
        left: calc(12.2 * (100% / 19));
      }

      /* C#5 (between C5 and D5, white key index 14) */
      .black-key[data-note="C#5"] {
        left: calc(14.2 * (100% / 19));
      }
      /* D#5 (between D5 and E5, white key index 15) */
      .black-key[data-note="D#5"] {
        left: calc(15.2 * (100% / 19));
      }
      /* F#5 (between F5 and G5, white key index 17) */
      .black-key[data-note="F#5"] {
        left: calc(17.2 * (100% / 19));
      }

      /* Responsive adjustments for overall container to ensure full width usage */
      @media (max-width: 1024px) {
        .piano-container {
          width: 98vw;
          padding: 1rem;
        }
        .black-keys {
          top: 1rem;
          left: 1rem;
          width: calc(100% - 2rem);
        }
        .key {
          font-size: 0.7rem;
          padding-bottom: 5px;
        }
      }
      @media (max-width: 768px) {
        .piano-container {
          height: 500px; /* Reduce height slightly on smaller screens */
        }
        .key {
          font-size: 0.6rem;
          padding-bottom: 3px;
          margin: 0 1px;
        }
      }
    </style>
  </head>
  <body>
    <div class="piano-container">
      <div class="white-keys">
        <!-- White Keys (19 total) -->
        <div class="key white-key" data-note="C3">C3</div>
        <div class="key white-key" data-note="D3">D3</div>
        <div class="key white-key" data-note="E3">E3</div>
        <div class="key white-key" data-note="F3">F3</div>
        <div class="key white-key" data-note="G3">G3</div>
        <div class="key white-key" data-note="A3">A3</div>
        <div class="key white-key" data-note="B3">B3</div>

        <div class="key white-key" data-note="C4">C4</div>
        <div class="key white-key" data-note="D4">D4</div>
        <div class="key white-key" data-note="E4">E4</div>
        <div class="key white-key" data-note="F4">F4</div>
        <div class="key white-key" data-note="G4">G4</div>
        <div class="key white-key" data-note="A4">A4</div>
        <div class="key white-key" data-note="B4">B4</div>

        <div class="key white-key" data-note="C5">C5</div>
        <div class="key white-key" data-note="D5">D5</div>
        <div class="key white-key" data-note="E5">E5</div>
        <div class="key white-key" data-note="F5">F5</div>
        <div class="key white-key" data-note="G5">G5</div>
      </div>
      <div class="black-keys">
        <!-- Black Keys (13 total) -->
        <div class="key black-key" data-note="C#3">C#3</div>
        <div class="key black-key" data-note="D#3">D#3</div>
        <div class="key black-key" data-note="F#3">F#3</div>
        <div class="key black-key" data-note="G#3">G#3</div>
        <div class="key black-key" data-note="A#3">A#3</div>

        <div class="key black-key" data-note="C#4">C#4</div>
        <div class="key black-key" data-note="D#4">D#4</div>
        <div class="key black-key" data-note="F#4">F#4</div>
        <div class="key black-key" data-note="G#4">G#4</div>
        <div class="key black-key" data-note="A#4">A#4</div>

        <div class="key black-key" data-note="C#5">C#5</div>
        <div class="key black-key" data-note="D#5">D#5</div>
        <div class="key black-key" data-note="F#5">F#5</div>
      </div>
    </div>
    <!-- Subtle page title -->
    <div
      class="fixed top-8 left-1/2 -translate-x-1/2 z-30 select-none text-gray-200 text-xl md:text-2xl font-semibold tracking-wide pointer-events-none"
      style="text-shadow: 0 2px 8px #222a; margin-top: 0.5rem"
    >
      Simple piano
    </div>
    <!-- Info button moved outside piano, using info.png icon -->
    <div class="fixed top-6 right-10 z-30 select-none">
      <button
        id="info-btn"
        title="Show keyboard mapping"
        class="bg-white/20 hover:bg-white/40 rounded-full w-8 h-8 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-white/60 transition"
        style="padding: 0"
      >
        <img
          src="assets/info.png"
          alt="info"
          class="w-5 h-5 pointer-events-none"
          draggable="false"
        />
      </button>
      <div
        id="info-overlay"
        class="hidden absolute right-0 mt-2 w-72 bg-gray-900/95 text-white text-xs rounded-lg shadow-lg p-4 border border-gray-700"
        style="backdrop-filter: blur(2px)"
      >
        <div class="font-semibold mb-2">Keyboard Mapping</div>
        <div class="mb-1">
          <span class="font-semibold">White Keys:</span>
        </div>
        <div class="ml-2 mb-1">
          C3â€“B3: <span class="font-mono">A S D F G H J</span>
        </div>
        <div class="ml-2 mb-1">
          C4â€“B4: <span class="font-mono">K L ; ' \ Z X</span>
        </div>
        <div class="ml-2 mb-2">
          C5â€“G5: <span class="font-mono">C V B N M</span>
        </div>
        <div class="mb-1">
          <span class="font-semibold">Black Keys:</span>
        </div>
        <div class="ml-2 mb-1">
          C#3â€“A#3: <span class="font-mono">W E T Y U</span>
        </div>
        <div class="ml-2 mb-1">
          C#4â€“A#4: <span class="font-mono">O P [ ] `</span>
        </div>
        <div class="ml-2">C#5â€“F#5: <span class="font-mono">1 2 3</span></div>
      </div>
    </div>
    <script>
      // Ensure Tone.js is loaded and ready
      window.onload = function () {
        // Create a reverb effect for a richer sound
        const reverb = new Tone.Reverb({
          decay: 2, // How long the reverb tail lasts (seconds)
          preDelay: 0.01, // Time before reverb starts
          wet: 0.4, // Amount of wet signal (reverb) vs dry signal (original)
        }).toDestination(); // Connect reverb to the speakers

        // Create a synth with a triangle oscillator and adjusted envelope for a more piano-like sound
        const synth = new Tone.PolySynth(Tone.Synth, {
          oscillator: {
            type: "triangle", // Triangle wave for a fuller sound
          },
          envelope: {
            attack: 0.005, // Very fast attack
            decay: 0.4, // Moderate decay
            sustain: 0.1, // Short sustain
            release: 1.2, // Longer release for piano resonance
          },
        }).connect(reverb); // Connect the synth to the reverb

        // Function to activate audio context on first user interaction
        function activateAudioContext() {
          if (Tone.context.state !== "running") {
            Tone.start();
            console.log("AudioContext resumed!");
          }
          // Remove the event listener after activation
          document.removeEventListener("touchstart", activateAudioContext);
          document.removeEventListener("mousedown", activateAudioContext);
        }

        // Add event listeners for touchstart and mousedown to activate audio context
        // This is crucial for audio playback in modern browsers
        document.addEventListener("touchstart", activateAudioContext, {
          once: true,
        });
        document.addEventListener("mousedown", activateAudioContext, {
          once: true,
        });

        // Select all piano keys
        const pianoKeys = document.querySelectorAll(".key");
        let activeTouches = {}; // To track multiple touches for polyphony (not primary for desktop but good practice)
        let pressedKeyboardKeys = new Set(); // To track currently pressed keyboard keys to prevent repeated notes

        // Function to play a note
        function playNote(note, keyElement) {
          // Check if the note is already active to prevent re-triggering
          if (!keyElement.classList.contains("active")) {
            synth.triggerAttack(note);
            keyElement.classList.add("active");
          }
        }

        // Function to release a note
        function releaseNote(note, keyElement) {
          // Ensure the key is currently active before releasing the note
          if (keyElement.classList.contains("active")) {
            synth.triggerRelease(note);
            keyElement.classList.remove("active");
          }
        }

        // Map keyboard codes to musical notes and their corresponding DOM elements
        const keyboardToNoteMap = {
          // White Keys (19) - Mapped to bottom two rows of QWERTY keyboard
          KeyA: {
            note: "C3",
            element: document.querySelector('[data-note="C3"]'),
          },
          KeyS: {
            note: "D3",
            element: document.querySelector('[data-note="D3"]'),
          },
          KeyD: {
            note: "E3",
            element: document.querySelector('[data-note="E3"]'),
          },
          KeyF: {
            note: "F3",
            element: document.querySelector('[data-note="F3"]'),
          },
          KeyG: {
            note: "G3",
            element: document.querySelector('[data-note="G3"]'),
          },
          KeyH: {
            note: "A3",
            element: document.querySelector('[data-note="A3"]'),
          },
          KeyJ: {
            note: "B3",
            element: document.querySelector('[data-note="B3"]'),
          },

          KeyK: {
            note: "C4",
            element: document.querySelector('[data-note="C4"]'),
          },
          KeyL: {
            note: "D4",
            element: document.querySelector('[data-note="D4"]'),
          },
          Semicolon: {
            note: "E4",
            element: document.querySelector('[data-note="E4"]'),
          },
          Quote: {
            note: "F4",
            element: document.querySelector('[data-note="F4"]'),
          },
          Backslash: {
            note: "G4",
            element: document.querySelector('[data-note="G4"]'),
          },
          KeyZ: {
            note: "A4",
            element: document.querySelector('[data-note="A4"]'),
          },
          KeyX: {
            note: "B4",
            element: document.querySelector('[data-note="B4"]'),
          },

          KeyC: {
            note: "C5",
            element: document.querySelector('[data-note="C5"]'),
          },
          KeyV: {
            note: "D5",
            element: document.querySelector('[data-note="D5"]'),
          },
          KeyB: {
            note: "E5",
            element: document.querySelector('[data-note="E5"]'),
          },
          KeyN: {
            note: "F5",
            element: document.querySelector('[data-note="F5"]'),
          },
          KeyM: {
            note: "G5",
            element: document.querySelector('[data-note="G5"]'),
          },

          // Black Keys (13) - Mapped to number row and other convenient keys
          KeyW: {
            note: "C#3",
            element: document.querySelector('[data-note="C#3"]'),
          },
          KeyE: {
            note: "D#3",
            element: document.querySelector('[data-note="D#3"]'),
          },
          KeyT: {
            note: "F#3",
            element: document.querySelector('[data-note="F#3"]'),
          },
          KeyY: {
            note: "G#3",
            element: document.querySelector('[data-note="G#3"]'),
          },
          KeyU: {
            note: "A#3",
            element: document.querySelector('[data-note="A#3"]'),
          },

          KeyO: {
            note: "C#4",
            element: document.querySelector('[data-note="C#4"]'),
          },
          KeyP: {
            note: "D#4",
            element: document.querySelector('[data-note="D#4"]'),
          },
          BracketLeft: {
            note: "F#4",
            element: document.querySelector('[data-note="F#4"]'),
          },
          BracketRight: {
            note: "G#4",
            element: document.querySelector('[data-note="G#4"]'),
          },
          Backquote: {
            note: "A#4",
            element: document.querySelector('[data-note="A#4"]'),
          },

          Digit1: {
            note: "C#5",
            element: document.querySelector('[data-note="C#5"]'),
          },
          Digit2: {
            note: "D#5",
            element: document.querySelector('[data-note="D#5"]'),
          },
          Digit3: {
            note: "F#5",
            element: document.querySelector('[data-note="F#5"]'),
          },
        };

        // Event listeners for mouse interaction
        pianoKeys.forEach((key) => {
          const note = key.dataset.note;
          key.addEventListener("mousedown", (e) => {
            e.preventDefault(); // Prevent text selection on long press
            playNote(note, key);
          });
          key.addEventListener("mouseup", () => {
            releaseNote(note, key);
          });
          // Handle mouse leaving the key while pressed
          key.addEventListener("mouseleave", () => {
            if (key.classList.contains("active")) {
              releaseNote(note, key);
            }
          });
        });

        // Event listeners for touch interaction (still included for basic touch support, though not mobile-optimized layout)
        pianoKeys.forEach((key) => {
          const note = key.dataset.note;
          key.addEventListener(
            "touchstart",
            (e) => {
              e.preventDefault(); // Prevent default browser touch behavior (e.g., scrolling)
              // Iterate through all touches to handle multi-touch
              Array.from(e.changedTouches).forEach((touch) => {
                const targetKey = e.target.closest(".key");
                if (targetKey && targetKey === key) {
                  // Ensure the touch started on this key
                  playNote(note, key);
                  activeTouches[touch.identifier] = {
                    keyElement: key,
                    note: note,
                  };
                }
              });
            },
            { passive: false }
          ); // Use passive: false to allow preventDefault
          key.addEventListener("touchend", (e) => {
            e.preventDefault(); // Prevent default browser touch behavior
            Array.from(e.changedTouches).forEach((touch) => {
              if (activeTouches[touch.identifier]) {
                releaseNote(
                  activeTouches[touch.identifier].note,
                  activeTouches[touch.identifier].keyElement
                );
                delete activeTouches[touch.identifier];
              }
            });
          });
          key.addEventListener("touchcancel", (e) => {
            e.preventDefault(); // Prevent default browser touch behavior
            Array.from(e.changedTouches).forEach((touch) => {
              if (activeTouches[touch.identifier]) {
                releaseNote(
                  activeTouches[touch.identifier].note,
                  activeTouches[touch.identifier].keyElement
                );
                delete activeTouches[touch.identifier];
              }
            });
          });
        });

        // Handle global mouse release to ensure notes are turned off if mouse is released anywhere
        document.addEventListener("mouseup", () => {
          pianoKeys.forEach((key) => {
            if (
              key.classList.contains("active") &&
              !pressedKeyboardKeys.has(key.dataset.keyboardCode)
            ) {
              releaseNote(key.dataset.note, key);
            }
          });
        });

        // Handle global touchend as a fallback
        document.addEventListener("touchend", (e) => {
          if (Object.keys(activeTouches).length === 0) {
            pianoKeys.forEach((key) => {
              if (key.classList.contains("active")) {
                releaseNote(key.dataset.note, key);
              }
            });
          }
        });

        // Keyboard event listeners
        document.addEventListener("keydown", (e) => {
          // Prevent default browser behavior for common keys that might scroll or trigger other actions
          if (e.code in keyboardToNoteMap && !pressedKeyboardKeys.has(e.code)) {
            e.preventDefault();
            const { note, element } = keyboardToNoteMap[e.code];
            playNote(note, element);
            pressedKeyboardKeys.add(e.code); // Mark key as pressed
          }
        });

        document.addEventListener("keyup", (e) => {
          if (e.code in keyboardToNoteMap && pressedKeyboardKeys.has(e.code)) {
            e.preventDefault();
            const { note, element } = keyboardToNoteMap[e.code];
            releaseNote(note, element);
            pressedKeyboardKeys.delete(e.code); // Mark key as released
          }
        });

        // Add keyboard code to data attributes for easier mapping in JS
        // This is done after DOM is loaded
        for (const code in keyboardToNoteMap) {
          if (keyboardToNoteMap[code].element) {
            keyboardToNoteMap[code].element.dataset.keyboardCode = code;
          }
        }

        // Info button overlay logic
        const infoBtn = document.getElementById("info-btn");
        const infoOverlay = document.getElementById("info-overlay");
        let infoVisible = false;

        function showInfo() {
          infoOverlay.classList.remove("hidden");
          infoVisible = true;
        }
        function hideInfo() {
          infoOverlay.classList.add("hidden");
          infoVisible = false;
        }
        infoBtn.addEventListener("mouseenter", showInfo);
        infoBtn.addEventListener("mouseleave", hideInfo);
        infoOverlay.addEventListener("mouseenter", showInfo);
        infoOverlay.addEventListener("mouseleave", hideInfo);
        // Also allow click to toggle for accessibility
        infoBtn.addEventListener("click", () => {
          if (infoVisible) {
            hideInfo();
          } else {
            showInfo();
          }
        });

        // Hide overlay if clicked outside
        document.addEventListener("click", (e) => {
          if (
            !infoBtn.contains(e.target) &&
            !infoOverlay.contains(e.target) &&
            !infoOverlay.classList.contains("hidden")
          ) {
            infoOverlay.classList.add("hidden");
            infoBtn.classList.remove("bg-white/40");
          }
        });
      };
    </script>
  </body>
</html>
