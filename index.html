<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simply Piano</title>
    <meta name="description" content="A simply piano app using Tone.js" />
    <link rel="icon" type="image/png" href="/assets/icons/icon.png" />
    <link rel="stylesheet" href="css/site.css" />
  </head>
  <body>
    <!-- Initial Loading Spinner -->
    <div
      id="loading-spinner"
      class="fixed inset-0 z-[100] min-h-[100dvh] flex items-center justify-center bg-gradient-to-br from-pink-500 via-purple-600 to-indigo-700"
      style="touch-action: none; position: fixed; height: 100dvh"
    >
      <div
        class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-white"
        style="will-change: transform"
      ></div>
    </div>
    <!-- Subtle page title -->
    <div
      class="fixed top-8 left-1/2 -translate-x-1/2 z-30 select-none text-gray-200 text-xl md:text-2xl font-semibold tracking-wide pointer-events-none"
      style="text-shadow: 0 2px 8px #222a; margin-top: 0.5rem"
    >
      Simply piano
    </div>
    <!-- Info button moved outside piano, using info.png icon -->
    <div class="fixed top-6 right-10 z-30 select-none">
      <button
        id="info-btn"
        title="Show keyboard mapping"
        class="bg-white/20 hover:bg-white/40 rounded-full w-8 h-8 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-white/60 transition"
        style="padding: 0"
      >
        <img
          src="assets/icons/info.png"
          alt="info"
          class="w-5 h-5 pointer-events-none"
          draggable="false"
        />
      </button>
      <div
        id="info-overlay"
        class="hidden absolute right-0 mt-2 w-72 bg-gray-900/95 text-white text-xs rounded-lg shadow-lg p-4 border border-gray-700"
        style="backdrop-filter: blur(2px)"
      >
        <div class="font-semibold mb-2">Keyboard layout used:</div>
        <img
          src="./assets/piano_docs/32-key-keyboard-1.jpg"
          alt="Keyboard layout"
          class="w-full rounded-lg mb-4"
          draggable="false"
        />
        <div class="mb-1">
          <span class="font-semibold">White Keys:</span>
        </div>
        <div class="ml-2 mb-1">
          C3–B3: <span class="font-mono">A S D F G H J</span>
        </div>
        <div class="ml-2 mb-1">
          C4–B4: <span class="font-mono">K L ; ' \ Z X</span>
        </div>
        <div class="ml-2 mb-2">
          C5–G5: <span class="font-mono">C V B N M</span>
        </div>
        <div class="mb-1">
          <span class="font-semibold">Black Keys:</span>
        </div>
        <div class="ml-2 mb-1">
          C#3–A#3: <span class="font-mono">W E T Y U</span>
        </div>
        <div class="ml-2 mb-1">
          C#4–A#4: <span class="font-mono">O P [ ] `</span>
        </div>
        <div class="ml-2 mb-2">
          C#5–F#5: <span class="font-mono">1 2 3</span>
        </div>
        <div class="border-t border-gray-700 pt-2">
          <div class="font-semibold mb-1">Self Playing Controls:</div>
          <div class="ml-2">1. Select a song from the dropdown menu</div>
          <div class="ml-2">2. Click "Self play" to start</div>
          <div class="ml-2">3. Click "Stop self play" to stop playback</div>
        </div>
      </div>
    </div>
    <div class="fixed top-6 left-6 z-50">
      <button
        id="power-btn"
        class="w-16 h-16 rounded-full bg-red-700 ring-2 ring-red-300 shadow-inner transition-all duration-300 text-white font-bold"
        title="Power"
      >
        ●
      </button>
    </div>
    <div class="piano-container">
      <div class="white-keys">
        <!-- White Keys (19 total) -->
        <div class="key white-key" data-note="C3">C3</div>
        <div class="key white-key" data-note="D3">D3</div>
        <div class="key white-key" data-note="E3">E3</div>
        <div class="key white-key" data-note="F3">F3</div>
        <div class="key white-key" data-note="G3">G3</div>
        <div class="key white-key" data-note="A3">A3</div>
        <div class="key white-key" data-note="B3">B3</div>

        <div class="key white-key" data-note="C4">C4</div>
        <div class="key white-key" data-note="D4">D4</div>
        <div class="key white-key" data-note="E4">E4</div>
        <div class="key white-key" data-note="F4">F4</div>
        <div class="key white-key" data-note="G4">G4</div>
        <div class="key white-key" data-note="A4">A4</div>
        <div class="key white-key" data-note="B4">B4</div>

        <div class="key white-key" data-note="C5">C5</div>
        <div class="key white-key" data-note="D5">D5</div>
        <div class="key white-key" data-note="E5">E5</div>
        <div class="key white-key" data-note="F5">F5</div>
        <div class="key white-key" data-note="G5">G5</div>
      </div>
      <div class="black-keys">
        <!-- Black Keys (13 total) -->
        <div class="key black-key" data-note="C#3">C#3</div>
        <div class="key black-key" data-note="D#3">D#3</div>
        <div class="key black-key" data-note="F#3">F#3</div>
        <div class="key black-key" data-note="G#3">G#3</div>
        <div class="key black-key" data-note="A#3">A#3</div>

        <div class="key black-key" data-note="C#4">C#4</div>
        <div class="key black-key" data-note="D#4">D#4</div>
        <div class="key black-key" data-note="F#4">F#4</div>
        <div class="key black-key" data-note="G#4">G#4</div>
        <div class="key black-key" data-note="A#4">A#4</div>

        <div class="key black-key" data-note="C#5">C#5</div>
        <div class="key black-key" data-note="D#5">D#5</div>
        <div class="key black-key" data-note="F#5">F#5</div>
      </div>
    </div>

    <!-- Song select and play button -->
    <div
      id="control-panel"
      class="fixed bottom-20 left-1/2 -translate-x-1/2 z-30 flex items-center gap-3 select-none"
    >
      <div
        class="flex flex-col sm:flex-row items-center gap-2 sm:gap-3 w-full sm:w-auto"
      >
        <div class="flex flex-col items-center gap-1 w-full sm:w-auto">
          <div class="flex flex-row gap-3 mb-4">
            <label class="flex flex-col items-center text-xs text-gray-200">
              Reverb
              <input
                id="reverb-slider"
                type="range"
                min="0"
                max="1"
                step="0.01"
                value="0.3"
                class="w-40 accent-blue-400"
              />
            </label>
            <label class="flex flex-col items-center text-xs text-gray-200">
              Chorus
              <input
                id="chorus-slider"
                type="range"
                min="0"
                max="1"
                step="0.01"
                value="0.5"
                class="w-40 accent-pink-400"
              />
            </label>
            <label class="flex flex-col items-center text-xs text-gray-200">
              Pitch
              <input
                id="pitch-slider"
                type="range"
                min="-1200"
                max="1200"
                step="1"
                value="0"
                class="w-40 accent-green-400"
              />
            </label>
            <label class="flex flex-col items-center text-xs text-gray-200">
              Volume
              <input
                id="volume-slider"
                type="range"
                min="-40"
                max="0"
                step="1"
                value="-8"
                class="w-40 accent-yellow-400"
              />
            </label>
          </div>
          <div class="flex flex-row items-center gap-3 w-full sm:w-auto">
            <select
              id="song-select"
              class="rounded-lg px-3 py-2 text-base bg-white/20 text-white focus:outline-none focus:ring-2 focus:ring-white/60 shadow w-full sm:w-auto"
            >
              <option value="twinkle" class="bg-gray-800 text-white">
                Twinkle Twinkle Little Star
              </option>
            </select>
            <button
              id="self-play-btn"
              class="bg-white/20 hover:bg-white/40 text-white rounded-lg px-5 py-2 text-base font-medium shadow transition focus:outline-none focus:ring-2 focus:ring-white/60 w-full sm:w-auto"
            >
              Self Play
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Mobile Blocker -->
    <div
      id="mobile-blocker"
      class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-pink-500 via-purple-600 to-indigo-700 text-white p-4 transition-opacity duration-500 ease-in-out opacity-0 pointer-events-none xl:hidden"
    >
      <div
        class="glass-effect p-8 rounded-2xl max-w-sm w-full text-center flex flex-col items-center justify-center space-y-4"
      >
        <svg
          class="w-24 h-24 text-white"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"
          ></path>
        </svg>
        <h2 class="text-3xl font-extrabold leading-tight">Simply Piano</h2>
        <p class="text-lg font-medium text-white text-opacity-80">
          For the best experience, please visit us on a larger screen, like a
          desktop computer.
        </p>
        <p class="text-sm text-white text-opacity-60 mt-4">
          Thank you for your understanding!
        </p>
      </div>
    </div>

    <div
      class="fixed bottom-4 left-1/2 -translate-x-1/2 text-sm font-semibold bg-clip-text text-transparent bg-gradient-to-r from-red-500 via-yellow-400 via-green-400 via-blue-500 to-purple-600 animate-pulse select-none pointer-events-none z-20 mb-1"
    >
      Created with Tone.js
    </div>

    <!-- Mobile Blocker -->
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for audio synthesis -->
    <script src="https://unpkg.com/tone"></script>
    <script type="module">
      import { initAudio } from "./js/audio.js";
      import {
        initPianoInteraction,
        disablePianoInteraction,
      } from "./js/pianoInteraction.js";
      import { initSelfPlayer, stopSongPlayback } from "./js/selfPlayer.js";
      import {
        initUI,
        enableControls,
        disableControls,
        updatePowerButton,
      } from "./js/ui.js";
      import { songSnippets, noteDurations } from "./js/songs.js";
      import { keyboardToNoteMap } from "./js/mappings.js";

      //--- STATE ---//
      let isPowerOn = false;
      let audioContext = {}; // Will hold { synth, reverb, chorus }

      //--- DOM ELEMENTS ---//
      const powerBtn = document.getElementById("power-btn");
      const selfPlayBtn = document.getElementById("self-play-btn");
      const songSelect = document.getElementById("song-select");

      // Initial setup on window load
      window.onload = () => {
        initUI(keyboardToNoteMap);
        disablePianoInteraction();
        disableControls();
        updatePowerButton(isPowerOn);
      };

      //--- POWER BUTTON LOGIC ---//
      powerBtn.addEventListener("click", async () => {
        isPowerOn = !isPowerOn;

        if (isPowerOn) {
          // --- TURNING ON --- //
          // Start Tone.js and create audio nodes
          await Tone.start();
          audioContext = await initAudio();

          // Initialize all interactive modules with the new audio context
          initPianoInteraction(audioContext.synth, keyboardToNoteMap);
          initSelfPlayer(
            audioContext.synth,
            songSnippets,
            noteDurations,
            selfPlayBtn,
            songSelect
          );

          // Pass audio context to UI for FX sliders
          const { synth, reverb, chorus } = audioContext;
          enableControls(synth, reverb, chorus);
        } else {
          // --- TURNING OFF --- //
          stopSongPlayback();
          audioContext.synth?.releaseAll();
          disablePianoInteraction();
          disableControls();
        }

        updatePowerButton(isPowerOn);
      });
    </script>
  </body>
</html>
